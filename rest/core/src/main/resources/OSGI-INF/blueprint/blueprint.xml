<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns:cxf="http://cxf.apache.org/blueprint/core"
           xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
           xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd


  http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd
  http://cxf.apache.org/blueprint/core http://cxf.apache.org/schemas/blueprint/core.xsd

  http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.1.0.xsd">
  <cm:property-placeholder persistent-id="com.pentaho.profiling.services"
                           update-strategy="reload">
  </cm:property-placeholder>

  <cxf:bus id="profilingServiceWebserviceImplBus">
  </cxf:bus>

  <jaxrs:server address="/profile" id="profileService">
    <jaxrs:serviceBeans>
      <ref component-id="profilingServiceWebserviceImpl"/>
    </jaxrs:serviceBeans>
    <jaxrs:providers>
      <ref component-id="jsonProvider"/>
    </jaxrs:providers>
  </jaxrs:server>

  <jaxrs:server address="/aggregate" id="aggregateProfileService">
    <jaxrs:serviceBeans>
      <ref component-id="aggregateProfileServiceRestImpl"/>
    </jaxrs:serviceBeans>
    <jaxrs:providers>
      <ref component-id="jsonProvider"/>
    </jaxrs:providers>
  </jaxrs:server>

  <jaxrs:server address="/metrics" id="metricContributorService">
    <jaxrs:serviceBeans>
      <ref component-id="metricContributorServiceImpl"/>
    </jaxrs:serviceBeans>
    <jaxrs:providers>
      <ref component-id="jsonProvider"/>
    </jaxrs:providers>
  </jaxrs:server>

  <jaxrs:server address="/streaming" id="streamingProfileServiceRestImplWebservice">
    <jaxrs:serviceBeans>
      <ref component-id="streamingProfileServiceRestImpl"/>
    </jaxrs:serviceBeans>
    <jaxrs:providers>
      <ref component-id="jsonProvider"/>
    </jaxrs:providers>
  </jaxrs:server>

  <jaxrs:server address="/data-profiling-service/dataSource" id="profileDsService">
    <jaxrs:serviceBeans>
      <ref component-id="profileDataSourceIncludeWebserviceImpl"/>
    </jaxrs:serviceBeans>
    <jaxrs:providers>
      <ref component-id="jsonProvider"/>
    </jaxrs:providers>
  </jaxrs:server>

  <bean id="metricContributorServiceImpl" class="com.pentaho.profiling.services.MetricContributorServiceImpl"
        scope="singleton">
    <argument ref="metricContributorServiceDelegate"/>
  </bean>

  <bean id="profilingServiceWebserviceImpl" class="com.pentaho.profiling.services.ProfilingServiceWebserviceImpl"
        scope="singleton">
    <argument ref="delegateRef"/>
  </bean>

  <bean id="profileDataSourceIncludeWebserviceImpl"
        class="com.pentaho.profiling.services.ProfileDataSourceIncludeWebserviceImpl">
    <property name="includeServices" ref="dsServiceList"/>
  </bean>

  <bean id="aggregateProfileServiceRestImpl" class="com.pentaho.profiling.services.AggregateProfileServiceRestImpl">
    <argument ref="delegateAggregateProfileService"/>
  </bean>

  <bean id="streamingProfileServiceRestImpl" class="com.pentaho.profiling.services.StreamingProfileServiceRestImpl"
        scope="singleton">
    <argument ref="streamingProfileService"/>
    <argument ref="metricObjectMapperFactory"/>
  </bean>

  <bean id="resourceMapping"
        class="org.ops4j.pax.web.extender.whiteboard.runtime.DefaultResourceMapping">
    <property name="alias" value="/profileWebView"/>
    <property name="path" value="/webview"/>
  </bean>
  <service id="resources" ref="resourceMapping" interface="org.ops4j.pax.web.extender.whiteboard.ResourceMapping"/>


  <bean id="defaultClassLoaderClass" factory-ref="aggregateProfileServiceRestImpl" factory-method="getClass"/>
  <bean id="metricObjectMapperFactory" class="com.pentaho.profiling.api.json.ObjectMapperFactory" scope="singleton">
    <argument ref="defaultClassLoaderClass"/>
  </bean>

  <bean id="jsonProvider" factory-ref="metricObjectMapperFactory" factory-method="createProvider"/>
  <reference-list id="metricContributorBundles"
                  interface="com.pentaho.profiling.api.metrics.bundle.MetricContributorBundle" availability="optional">
    <reference-listener ref="metricObjectMapperFactory" bind-method="hasClassesAdded" unbind-method="hasClassesRemoved"/>
  </reference-list>

  <reference id="delegateRef" interface="com.pentaho.profiling.api.ProfilingService"/>
  <reference id="delegateAggregateProfileService" interface="com.pentaho.profiling.api.AggregateProfileService"/>
  <reference id="metricContributorServiceDelegate"
             interface="com.pentaho.profiling.api.metrics.MetricContributorService"/>
  <reference id="streamingProfileService" interface="com.pentaho.profiling.api.StreamingProfileService"/>
  <reference-list id="dsServiceList" interface="com.pentaho.profiling.services.api.ProfileDataSourceIncludeService"
                  availability="optional"/>
</blueprint>